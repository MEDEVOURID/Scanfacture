<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Facture Live</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- STYLE GENERAL --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; }

        /* --- ZONE CAMERA LIVE --- */
        .camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: none; /* Cach√© par d√©faut */
        }

        video {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Bouton flottant pour prendre la photo */
        .capture-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 60px;
            background-color: white;
            border-radius: 50%;
            border: 4px solid rgba(0,0,0,0.2);
            cursor: pointer;
            z-index: 10;
        }
        .capture-btn:active { background-color: #ccc; }

        /* --- ZONE UPLOAD CLASSIQUE (Fallback) --- */
        .action-buttons { text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        #preview-img { max-width: 100%; max-height: 300px; margin: 15px auto; display: none; border-radius: 8px; border: 2px solid #ddd; }
        #status { margin-top: 10px; font-weight: bold; color: #d35400; text-align: center; font-size: 0.9rem; min-height: 20px; }

        /* --- FORMULAIRE --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; }
        .section-header { grid-column: 1 / -1; background: #f8f9fa; padding: 10px; font-weight: bold; margin-top: 10px; border-left: 4px solid #3498db; color: #2c3e50; text-transform: uppercase; font-size: 0.85em; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; background-color: #fafafa; }
        input:focus { border-color: #3498db; background-color: #fff; outline: none; }

        /* --- BOUTONS --- */
        .btn { border: none; padding: 12px 20px; border-radius: 8px; font-size: 15px; cursor: pointer; color: white; font-weight: 600; transition: 0.2s; }
        .btn-blue { background-color: #3498db; }
        .btn-orange { background-color: #e67e22; width: 100%; max-width: 300px; }
        .btn-green { background-color: #27ae60; }
        .btn-red { background-color: #e74c3c; padding: 6px 12px; }
        .btn:disabled { background-color: #bdc3c7; opacity: 0.7; cursor: not-allowed; }

        /* --- TABLEAU --- */
        .table-container { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; font-size: 14px; }
        th { background-color: #3498db; color: white; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üì∏ Scanner Facture (Live)</h1>

    <div class="action-buttons">
        <button class="btn btn-blue" onclick="startCamera()">üì∑ Activer Cam√©ra</button>
        <button class="btn btn-green" onclick="document.getElementById('file-input').click()">üìÇ Importer Fichier</button>
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <div class="camera-wrapper" id="camera-wrapper">
        <video id="video" autoplay playsinline></video>
        <button class="capture-btn" onclick="takePhoto()" title="Prendre la photo"></button>
    </div>
    
    <canvas id="canvas" style="display:none;"></canvas>

    <img id="preview-img" alt="Aper√ßu">
    <p id="status"></p>

    <div id="data-form" style="display:none;">
        <h3 style="text-align:center;">V√©rification</h3>
        <div class="form-grid">
            <div class="section-header">üè¢ Fournisseur</div>
            <div class="full-width"><label>Nom</label><input type="text" id="emetteur_nom"></div>
            <div><label>Adresse</label><input type="text" id="emetteur_adresse"></div>
            <div><label>SIRET</label><input type="text" id="emetteur_siret"></div>
            
            <div class="section-header">üë§ Client</div>
            <div class="full-width"><label>Nom</label><input type="text" id="client_nom"></div>

            <div class="section-header">üìÑ Info Facture</div>
            <div><label>Num√©ro</label><input type="text" id="facture_num"></div>
            <div><label>Date</label><input type="date" id="facture_date"></div>

            <div class="section-header">üì¶ D√©tail & Prix</div>
            <div class="full-width"><label>D√©signation</label><input type="text" id="detail_designation"></div>
            <div><label>Total HT</label><input type="number" step="0.01" id="total_ht"></div>
            <div><label>Montant TVA</label><input type="number" step="0.01" id="total_tva"></div>
            <div class="full-width">
                <label style="color:#27ae60;">TOTAL TTC</label>
                <input type="number" step="0.01" id="total_ttc" style="background:#e8f8f5; font-weight:bold; font-size:1.2em; border: 2px solid #27ae60; color:#27ae60;">
            </div>

            <div style="display:none;">
                <input id="emetteur_statut"><input id="emetteur_tva"><input id="client_adresse"><input id="client_tva">
                <input id="detail_qte" value="1"><input id="detail_pu"><input id="detail_taux_tva" value="20"><input id="detail_total_ligne">
                <input id="mention_echeance"><input id="mention_penalites" value="Taux l√©gal"><input id="mention_indemnite" value="Oui">
                <input id="mention_bc"><input id="mention_assurance"><input id="mention_conditions">
            </div>
        </div>

        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-orange" onclick="addInvoiceToList()">‚ûï Valider</button>
            <button class="btn" style="background:#95a5a6; margin-top:10px;" onclick="resetUI()">Annuler</button>
        </div>
    </div>

    <div class="table-container">
        <h3>Factures scann√©es</h3>
        <table id="invoices-table">
            <thead><tr><th>Date</th><th>Fournisseur</th><th>TTC</th><th>Action</th></tr></thead>
            <tbody id="table-body">
                <tr><td colspan="4" style="text-align:center; padding:15px; color:#999;">Liste vide.</td></tr>
            </tbody>
        </table>
        <div style="text-align:center; margin-top:20px;">
            <button id="btn-export" class="btn btn-green" onclick="exportFinalExcel()" disabled>üì• T√©l√©charger Excel</button>
        </div>
    </div>
</div>

<script>
    let allInvoices = [];
    let videoStream = null;

    // Elements DOM
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const previewImg = document.getElementById('preview-img');
    const statusText = document.getElementById('status');
    const dataForm = document.getElementById('data-form');
    const fileInput = document.getElementById('file-input');

    // --- 1. GESTION CAMERA LIVE (getUserMedia) ---
    async function startCamera() {
        // Cacher l'ancien aper√ßu et le formulaire
        resetUI();
        
        try {
            // Demande l'acc√®s √† la cam√©ra (environment = cam√©ra arri√®re sur mobile)
            videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: { exact: "environment" } } 
            }).catch(() => {
                // Fallback si "exact environment" √©choue (souvent sur PC)
                return navigator.mediaDevices.getUserMedia({ video: true });
            });

            video.srcObject = videoStream;
            cameraWrapper.style.display = 'block';
            statusText.innerText = "Cadrez la facture et appuyez sur le rond blanc.";
        } catch (err) {
            alert("Erreur cam√©ra : " + err.message + "\nAssurez-vous d'√™tre en HTTPS.");
            console.error(err);
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        cameraWrapper.style.display = 'none';
    }

    function takePhoto() {
        // Dessiner l'image vid√©o sur le canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Convertir en image
        const dataUrl = canvas.toDataURL('image/png');
        previewImg.src = dataUrl;
        previewImg.style.display = 'block';
        
        stopCamera(); // Arr√™ter la vid√©o
        runOCR(dataUrl); // Lancer l'analyse
    }

    // --- 2. GESTION UPLOAD CLASSIQUE ---
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            resetUI();
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            runOCR(e.target.result); // Peut prendre base64 ou File
        };
        reader.readAsDataURL(file);
    });

    // --- 3. OCR (MOTEUR D'ANALYSE) ---
    async function runOCR(imageSource) {
        statusText.innerText = "‚è≥ Analyse en cours... Patientez.";
        
        try {
            const { data: { text } } = await Tesseract.recognize(
                imageSource,
                'fra', // Fran√ßais
                { logger: m => { if(m.status === 'recognizing text') statusText.innerText = `‚è≥ Lecture : ${Math.round(m.progress * 100)}%`; } }
            );

            statusText.innerText = "‚úÖ Analyse termin√©e !";
            parseTextToForm(text);
            dataForm.style.display = 'block';
            dataForm.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            statusText.innerText = "‚ùå Erreur OCR : " + error.message;
        }
    }

    function parseTextToForm(text) {
        // Nettoyage et regex (Identique √† la version pr√©c√©dente)
        document.getElementById('emetteur_nom').value = '';
        document.getElementById('facture_num').value = '';
        
        const findMatch = (regex) => { const m = text.match(regex); return m ? m[1] || m[0] : ''; };

        // Date
        const dateStr = findMatch(/(\d{2}[/-]\d{2}[/-]\d{4})/);
        if(dateStr) {
            const parts = dateStr.split(/[\/-]/);
            if(parts.length === 3) document.getElementById('facture_date').value = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        // SIRET & Num√©ro
        document.getElementById('emetteur_siret').value = findMatch(/\b\d{14}\b/);
        document.getElementById('facture_num').value = findMatch(/Facture\s*n?¬∞?\s*([A-Za-z0-9-]+)/i);

        // Prix (TTC, HT, TVA)
        const prices = text.match(/\b\d+[.,]\d{2}\b/g);
        if(prices) {
            const numbers = prices.map(p => parseFloat(p.replace(',', '.'))).sort((a,b) => b-a);
            if(numbers.length > 0) document.getElementById('total_ttc').value = numbers[0]; 
            if(numbers.length > 1) document.getElementById('total_ht').value = numbers[1];
            if(numbers.length > 1) document.getElementById('total_tva').value = (numbers[0] - numbers[1]).toFixed(2);
        }
        // D√©signation
        document.getElementById('detail_designation').value = text.split('\n').slice(0, 3).join(' ').substring(0, 60);
    }

    // --- 4. GESTION DONNEES & TABLEAU ---
    function addInvoiceToList() {
        const invoice = {
            id: Date.now(),
            // R√©cup√©ration de tous les champs (visibles et cach√©s)
            emetteur_nom: document.getElementById('emetteur_nom').value,
            emetteur_adresse: document.getElementById('emetteur_adresse').value,
            emetteur_siret: document.getElementById('emetteur_siret').value,
            emetteur_statut: document.getElementById('emetteur_statut').value,
            emetteur_tva: document.getElementById('emetteur_tva').value,
            client_nom: document.getElementById('client_nom').value,
            client_adresse: document.getElementById('client_adresse').value,
            client_tva: document.getElementById('client_tva').value,
            facture_num: document.getElementById('facture_num').value,
            facture_date: document.getElementById('facture_date').value,
            detail_designation: document.getElementById('detail_designation').value,
            detail_qte: document.getElementById('detail_qte').value,
            detail_pu: document.getElementById('detail_pu').value,
            detail_taux: document.getElementById('detail_taux_tva').value,
            detail_total: document.getElementById('detail_total_ligne').value,
            total_ht: document.getElementById('total_ht').value,
            total_tva: document.getElementById('total_tva').value,
            total_ttc: document.getElementById('total_ttc').value,
            mention_echeance: document.getElementById('mention_echeance').value,
            mention_penalites: document.getElementById('mention_penalites').value,
            mention_indemnite: document.getElementById('mention_indemnite').value,
            mention_bc: document.getElementById('mention_bc').value,
            mention_assurance: document.getElementById('mention_assurance').value,
            mention_conditions: document.getElementById('mention_conditions').value
        };

        allInvoices.push(invoice);
        renderTable();
        resetUI();
        alert("Facture ajout√©e !");
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const btnExport = document.getElementById('btn-export');
        tbody.innerHTML = "";
        
        if (allInvoices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px; color:#999;">Liste vide.</td></tr>';
            btnExport.disabled = true; return;
        }

        btnExport.disabled = false;
        allInvoices.forEach((inv, index) => {
            tbody.innerHTML += `<tr>
                <td>${inv.facture_date}</td>
                <td>${inv.emetteur_nom || '...'}</td>
                <td style="font-weight:bold">${inv.total_ttc} ‚Ç¨</td>
                <td><button class="btn btn-red" onclick="deleteInvoice(${index})">X</button></td>
            </tr>`;
        });
    }

    function deleteInvoice(index) {
        if(confirm("Supprimer ?")) { allInvoices.splice(index, 1); renderTable(); }
    }

    function resetUI() {
        dataForm.style.display = 'none';
        previewImg.style.display = 'none';
        statusText.innerText = '';
        stopCamera();
    }

    // --- 5. EXPORT EXCEL ---
    function exportFinalExcel() {
        // Mapping pour Excel avec titres de colonnes propres
        const excelData = allInvoices.map(inv => ({
            "Nom √âmetteur": inv.emetteur_nom, "Adresse √âmetteur": inv.emetteur_adresse, "Statut Juridique": inv.emetteur_statut,
            "SIREN/SIRET": inv.emetteur_siret, "N¬∞ TVA √âmetteur": inv.emetteur_tva, "Nom Client": inv.client_nom,
            "Adresse Client": inv.client_adresse, "N¬∞ TVA Client": inv.client_tva, "Num√©ro Facture": inv.facture_num,
            "Date √âmission": inv.facture_date, "D√©signation": inv.detail_designation, "Quantit√©": inv.detail_qte,
            "Prix Unit. HT": inv.detail_pu, "Taux TVA (%)": inv.detail_taux, "Total Ligne HT": inv.detail_total,
            "Total HT Global": inv.total_ht, "Montant TVA": inv.total_tva, "Total TTC": inv.total_ttc,
            "√âch√©ance": inv.mention_echeance, "P√©nalit√©s": inv.mention_penalites, "Indemnit√© 40‚Ç¨": inv.mention_indemnite,
            "Bon Commande": inv.mention_bc, "Conditions Paiement": inv.mention_conditions, "Assurance": inv.mention_assurance
        }));
        
        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Compta");
        XLSX.writeFile(wb, `Scan_Factures_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
</script>

</body>
</html>
