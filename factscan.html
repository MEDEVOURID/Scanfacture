<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Facture HD</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- STYLE IDENTIQUE AVEC AJOUTS POUR LA CAM√âRA --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 10px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; }

        /* --- ZONE CAMERA HD --- */
        .camera-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 20px auto;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            display: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        video { width: 100%; height: auto; display: block; object-fit: cover; }

        /* Bouton Capture Rond Blanc */
        .capture-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 70px; background-color: rgba(255,255,255,0.9);
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.4);
            cursor: pointer; z-index: 10; box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
        .capture-btn:active { transform: translateX(-50%) scale(0.95); background-color: #fff; }

        /* Bouton Flash */
        .flash-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0,0,0,0.5); color: white; border: 1px solid white;
            border-radius: 50%; width: 40px; height: 40px; font-size: 20px;
            display: none; cursor: pointer; z-index: 10; align-items: center; justify-content: center;
        }

        /* --- BUTTONS & UI --- */
        .action-buttons { text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        #preview-img { max-width: 100%; max-height: 400px; margin: 15px auto; display: none; border-radius: 8px; border: 2px solid #ddd; }
        #status { margin-top: 10px; font-weight: bold; color: #d35400; text-align: center; font-size: 0.9rem; min-height: 20px; }
        
        /* FORM & TABLE STYLES (Conserv√©s) */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; }
        .section-header { grid-column: 1 / -1; background: #f8f9fa; padding: 10px; font-weight: bold; margin-top: 10px; border-left: 4px solid #3498db; color: #2c3e50; font-size: 0.85em; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; background-color: #fafafa; }
        input:focus { border-color: #3498db; background-color: #fff; outline: none; }
        
        .btn { border: none; padding: 12px 20px; border-radius: 8px; font-size: 15px; cursor: pointer; color: white; font-weight: 600; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #27ae60; }
        .btn-orange { background-color: #e67e22; width: 100%; }
        .btn-red { background-color: #e74c3c; padding: 6px 12px; }
        .table-container { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #3498db; color: white; }

        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .btn { width: 100%; } }
    </style>
</head>
<body>

<div class="container">
    <h1>üì∏ Scanner Facture HD</h1>

    <div class="action-buttons">
        <button class="btn btn-blue" onclick="startCamera()">üì∑ Activer Cam√©ra HD</button>
        <button class="btn btn-green" onclick="document.getElementById('file-input').click()">üìÇ Importer Image</button>
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <div class="camera-wrapper" id="camera-wrapper">
        <video id="video" autoplay playsinline></video>
        <button class="flash-btn" id="flash-btn" onclick="toggleTorch()">‚ö°</button>
        <button class="capture-btn" onclick="takePhoto()" title="Prendre photo"></button>
    </div>
    
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview-img" alt="Aper√ßu">
    <p id="status"></p>

    <div id="data-form" style="display:none;">
        <h3 style="text-align:center;">V√©rification des donn√©es</h3>
        <div class="form-grid">
            <div class="section-header">üè¢ Fournisseur</div>
            <div class="full-width"><label>Nom</label><input type="text" id="emetteur_nom"></div>
            <div class="full-width"><label>Adresse</label><input type="text" id="emetteur_adresse"></div>
            <div><label>SIRET</label><input type="text" id="emetteur_siret"></div>

            <div class="section-header">üìÑ Facture</div>
            <div><label>Num√©ro</label><input type="text" id="facture_num"></div>
            <div><label>Date</label><input type="date" id="facture_date"></div>
            <div class="full-width"><label>Client</label><input type="text" id="client_nom"></div>

            <div class="section-header">üí∞ Montants</div>
            <div class="full-width"><label>D√©signation</label><input type="text" id="detail_designation"></div>
            <div><label>Total HT</label><input type="number" step="0.01" id="total_ht"></div>
            <div><label>TVA</label><input type="number" step="0.01" id="total_tva"></div>
            <div class="full-width">
                <label style="color:#27ae60;">Total TTC</label>
                <input type="number" step="0.01" id="total_ttc" style="font-weight:bold; color:#27ae60; border:2px solid #27ae60;">
            </div>

            <div style="display:none;">
                <input id="emetteur_statut"><input id="emetteur_tva"><input id="client_adresse"><input id="client_tva">
                <input id="detail_qte" value="1"><input id="detail_pu"><input id="detail_taux_tva" value="20"><input id="detail_total_ligne">
                <input id="mention_echeance"><input id="mention_penalites" value="Taux l√©gal"><input id="mention_indemnite" value="Oui">
                <input id="mention_bc"><input id="mention_assurance"><input id="mention_conditions">
            </div>
        </div>

        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-orange" onclick="addInvoiceToList()">‚ûï Valider</button>
            <button class="btn" style="background:#95a5a6; margin-top:10px;" onclick="resetUI()">Annuler</button>
        </div>
    </div>

    <div class="table-container">
        <h3>Liste (Session en cours)</h3>
        <table id="invoices-table">
            <thead><tr><th>Date</th><th>Fournisseur</th><th>TTC</th><th>Action</th></tr></thead>
            <tbody id="table-body">
                <tr><td colspan="4" style="text-align:center; padding:15px; color:#999;">Aucune donn√©e.</td></tr>
            </tbody>
        </table>
        <div style="text-align:center; margin-top:20px;">
            <button id="btn-export" class="btn btn-green" onclick="exportFinalExcel()" disabled>üì• Excel Complet</button>
        </div>
    </div>
</div>

<script>
    let allInvoices = [];
    let videoStream = null;
    let track = null; // Piste vid√©o pour le contr√¥le (Zoom/Flash)
    let torchStatus = false;

    // DOM Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const previewImg = document.getElementById('preview-img');
    const statusText = document.getElementById('status');
    const dataForm = document.getElementById('data-form');
    const flashBtn = document.getElementById('flash-btn');

    // --- 1. CAMERA HAUTE DEFINITION ---
    async function startCamera() {
        resetUI();
        
        // Configuration HD : On demande une r√©solution id√©ale tr√®s haute (4K)
        // Si le t√©l√©phone ne peut pas, il donnera la meilleure dispo (1080p ou 720p)
        const constraints = {
            video: {
                facingMode: { exact: "environment" }, // Cam√©ra arri√®re
                width: { ideal: 4096 }, // Demande 4K
                height: { ideal: 2160 },
                focusMode: { ideal: "continuous" } // Demande autofocus
            }
        };

        try {
            videoStream = await navigator.mediaDevices.getUserMedia(constraints)
                .catch(err => navigator.mediaDevices.getUserMedia({ video: true })); // Fallback PC

            video.srcObject = videoStream;
            cameraWrapper.style.display = 'block';
            statusText.innerText = "Stabilisez la cam√©ra et prenez la photo.";

            // R√©cup√©ration des capacit√©s (pour le Flash)
            track = videoStream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();
            
            // Si le flash est dispo, on affiche le bouton
            if (capabilities.torch) {
                flashBtn.style.display = 'flex';
            }

        } catch (err) {
            alert("Erreur acc√®s cam√©ra (V√©rifiez HTTPS) : " + err.message);
        }
    }

    // Gestion du Flash
    async function toggleTorch() {
        if (!track) return;
        torchStatus = !torchStatus;
        try {
            await track.applyConstraints({ advanced: [{ torch: torchStatus }] });
            flashBtn.style.background = torchStatus ? "rgba(255,255,0,0.5)" : "rgba(0,0,0,0.5)";
        } catch (err) {
            console.error("Flash erreur:", err);
        }
    }

    function stopCamera() {
        if (videoStream) {
            // Eteindre le flash avant de couper
            if(torchStatus && track) track.applyConstraints({ advanced: [{ torch: false }] });
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        cameraWrapper.style.display = 'none';
        flashBtn.style.display = 'none';
    }

    function takePhoto() {
        // Capture √† la R√âSOLUTION R√âELLE de la cam√©ra (pas la taille affich√©e √† l'√©cran)
        canvas.width = video.videoWidth; 
        canvas.height = video.videoHeight;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Am√©lioration simple : convertir en image
        const dataUrl = canvas.toDataURL('image/jpeg', 1.0); // Qualit√© max JPG
        
        previewImg.src = dataUrl;
        previewImg.style.display = 'block';
        
        stopCamera();
        runOCR(dataUrl);
    }

    // --- 2. OCR & PARSING ---
    async function runOCR(imageSource) {
        statusText.innerText = "üîç Traitement HD en cours...";
        
        try {
            const { data: { text } } = await Tesseract.recognize(imageSource, 'fra', {
                logger: m => { if(m.status === 'recognizing text') statusText.innerText = `‚è≥ Lecture : ${Math.round(m.progress * 100)}%`; }
            });

            statusText.innerText = "‚úÖ Analyse termin√©e.";
            parseTextToForm(text);
            dataForm.style.display = 'block';
            dataForm.scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
            statusText.innerText = "‚ùå Erreur OCR : " + error.message;
        }
    }

    // Fonction de parsing identique √† la pr√©c√©dente (Optimis√©e Regex)
    function parseTextToForm(text) {
        document.getElementById('emetteur_nom').value = '';
        document.getElementById('facture_num').value = '';
        
        const find = (regex) => (text.match(regex) || [])[1] || '';
        const findRaw = (regex) => (text.match(regex) || [])[0] || '';

        // Dates (JJ/MM/AAAA ou AAAA-MM-JJ)
        let dateRaw = findRaw(/(\d{2}[\/\-]\d{2}[\/\-]\d{4})/);
        if(dateRaw) {
            let [d, m, y] = dateRaw.split(/[\/\-]/);
            document.getElementById('facture_date').value = `${y}-${m}-${d}`;
        }

        // SIRET
        document.getElementById('emetteur_siret').value = findRaw(/\b\d{14}\b/);
        // Num√©ro Facture
        document.getElementById('facture_num').value = find(/Facture\s*n?¬∞?[:\s]*([A-Z0-9\-\/]+)/i);

        // Prix (Cherche montants format√©s)
        const prices = text.match(/\b\d+[\.,]\d{2}\b/g);
        if(prices) {
            const nums = prices.map(p => parseFloat(p.replace(',', '.'))).sort((a,b) => b-a);
            if(nums.length > 0) document.getElementById('total_ttc').value = nums[0]; 
            if(nums.length > 1) document.getElementById('total_ht').value = nums[1];
            if(nums.length > 1) document.getElementById('total_tva').value = (nums[0] - nums[1]).toFixed(2);
        }
        
        // Texte (Premi√®re ligne pertinente)
        const lines = text.split('\n').filter(l => l.length > 5 && !l.match(/facture|date|total/i));
        if(lines.length > 0) document.getElementById('detail_designation').value = lines[0].substring(0, 50);
    }

    // --- 3. GESTION LISTE & EXPORT ---
    function addInvoiceToList() {
        const getVal = (id) => document.getElementById(id).value;
        
        const invoice = {
            id: Date.now(),
            emetteur_nom: getVal('emetteur_nom'), emetteur_adresse: getVal('emetteur_adresse'), emetteur_siret: getVal('emetteur_siret'),
            emetteur_statut: getVal('emetteur_statut'), emetteur_tva: getVal('emetteur_tva'),
            client_nom: getVal('client_nom'), client_adresse: getVal('client_adresse'), client_tva: getVal('client_tva'),
            facture_num: getVal('facture_num'), facture_date: getVal('facture_date'),
            detail_designation: getVal('detail_designation'), detail_qte: getVal('detail_qte'), detail_pu: getVal('detail_pu'),
            detail_taux: getVal('detail_taux_tva'), detail_total: getVal('detail_total_ligne'),
            total_ht: getVal('total_ht'), total_tva: getVal('total_tva'), total_ttc: getVal('total_ttc'),
            mention_echeance: getVal('mention_echeance'), mention_penalites: getVal('mention_penalites'),
            mention_indemnite: getVal('mention_indemnite'), mention_bc: getVal('mention_bc'),
            mention_conditions: getVal('mention_conditions'), mention_assurance: getVal('mention_assurance')
        };

        allInvoices.push(invoice);
        renderTable();
        resetUI();
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const btnExport = document.getElementById('btn-export');
        tbody.innerHTML = "";
        
        if (allInvoices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999;">Aucune donn√©e.</td></tr>';
            btnExport.disabled = true; return;
        }

        btnExport.disabled = false;
        allInvoices.forEach((inv, index) => {
            tbody.innerHTML += `<tr>
                <td>${inv.facture_date}</td><td>${inv.emetteur_nom}</td>
                <td><strong>${inv.total_ttc} ‚Ç¨</strong></td>
                <td><button class="btn btn-red" onclick="deleteInvoice(${index})">üóëÔ∏è</button></td>
            </tr>`;
        });
    }

    function deleteInvoice(idx) { if(confirm("Supprimer ?")) { allInvoices.splice(idx,1); renderTable(); }}

    function resetUI() {
        dataForm.style.display = 'none'; previewImg.style.display = 'none';
        statusText.innerText = ''; stopCamera();
        document.getElementById('file-input').value = '';
    }

    function exportFinalExcel() {
        const data = allInvoices.map(inv => ({
            "Fournisseur": inv.emetteur_nom, "Adresse Frn": inv.emetteur_adresse, "SIRET": inv.emetteur_siret,
            "Client": inv.client_nom, "Facture N¬∞": inv.facture_num, "Date": inv.facture_date,
            "Libell√©": inv.detail_designation, "HT Global": parseFloat(inv.total_ht||0), 
            "TVA": parseFloat(inv.total_tva||0), "TTC": parseFloat(inv.total_ttc||0),
            "Ech√©ance": inv.mention_echeance, "Conditions": inv.mention_conditions
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Compta");
        XLSX.writeFile(wb, `Scan_HD_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // Gestion de l'input fichier classique (fallback)
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = evt => { resetUI(); previewImg.src = evt.target.result; previewImg.style.display='block'; runOCR(evt.target.result); };
        reader.readAsDataURL(file);
    });
</script>

</body>
</html>
