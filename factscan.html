<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Facture Complet</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- STYLE GENERAL --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 10px; }
        .container { max-width: 100%; margin: 0 auto; background: white; padding: 10px; border-radius: 8px; } /* Max-width 100% pour profiter de l'espace */
        h1 { text-align: center; color: #2c3e50; font-size: 1.4rem; margin-bottom: 15px; }

        /* --- CAMERA & BOUTONS --- */
        .camera-wrapper {
            position: relative; width: 100%; max-width: 500px; margin: 0 auto 20px auto;
            background: #000; border-radius: 12px; overflow: hidden; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        video { width: 100%; height: auto; display: block; object-fit: cover; }
        
        .capture-btn {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 70px; background-color: rgba(255,255,255,0.9);
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.4);
            cursor: pointer; z-index: 10;
        }
        .flash-btn {
            position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white;
            border: 1px solid white; border-radius: 50%; width: 40px; height: 40px; font-size: 20px;
            display: none; cursor: pointer; z-index: 10; align-items: center; justify-content: center;
        }

        .action-buttons { text-align: center; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        #preview-img { max-width: 100%; max-height: 300px; margin: 15px auto; display: none; border-radius: 8px; border: 2px solid #ddd; }
        #status { font-weight: bold; color: #d35400; text-align: center; margin: 10px 0; }

        /* --- FORMULAIRE --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; padding: 15px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; }
        .section-header { grid-column: 1 / -1; background: #f8f9fa; padding: 8px; font-weight: bold; border-left: 4px solid #3498db; margin-top: 10px; }
        .full-width { grid-column: 1 / -1; }
        label { display: block; font-size: 11px; color: #666; font-weight: 600; margin-bottom: 2px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; background: #fafafa; }
        input:focus { border-color: #3498db; background: #fff; }

        .btn { border: none; padding: 10px 20px; border-radius: 6px; font-size: 14px; cursor: pointer; color: white; font-weight: 600; }
        .btn-blue { background-color: #3498db; }
        .btn-green { background-color: #27ae60; }
        .btn-orange { background-color: #e67e22; width: 100%; }
        .btn-red { background-color: #e74c3c; padding: 4px 8px; font-size: 12px; }

        /* --- TABLEAU COMPLET --- */
        .table-wrapper {
            margin-top: 30px;
            width: 100%;
            overflow-x: auto; /* Permet le scroll horizontal */
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            white-space: nowrap; /* Emp√™che le texte de passer √† la ligne */
        }

        th { background-color: #3498db; color: white; padding: 10px; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #eee; border-right: 1px solid #f0f0f0; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #eef7fc; }

    </style>
</head>
<body>

<div class="container">
    <h1>üì∏ Scanner Complet</h1>

    <div class="action-buttons">
        <button class="btn btn-blue" onclick="startCamera()">üì∑ Cam√©ra HD</button>
        <button class="btn btn-green" onclick="document.getElementById('file-input').click()">üìÇ Fichier</button>
        <input type="file" id="file-input" accept="image/*" style="display:none">
    </div>

    <div class="camera-wrapper" id="camera-wrapper">
        <video id="video" autoplay playsinline></video>
        <button class="flash-btn" id="flash-btn" onclick="toggleTorch()">‚ö°</button>
        <button class="capture-btn" onclick="takePhoto()"></button>
    </div>
    
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview-img" alt="Aper√ßu">
    <p id="status"></p>

    <div id="data-form" style="display:none;">
        <h3 style="text-align:center;">V√©rification</h3>
        <div class="form-grid">
            <div class="section-header">üè¢ Fournisseur</div>
            <div class="full-width"><label>Nom</label><input type="text" id="emetteur_nom"></div>
            <div class="full-width"><label>Adresse</label><input type="text" id="emetteur_adresse"></div>
            <div><label>SIRET</label><input type="text" id="emetteur_siret"></div>
            <div><label>Statut</label><input type="text" id="emetteur_statut"></div>
            <div><label>TVA Fournisseur</label><input type="text" id="emetteur_tva"></div>

            <div class="section-header">üë§ Client</div>
            <div class="full-width"><label>Nom Client</label><input type="text" id="client_nom"></div>
            <div class="full-width"><label>Adresse Client</label><input type="text" id="client_adresse"></div>
            <div><label>TVA Client</label><input type="text" id="client_tva"></div>

            <div class="section-header">üìÑ D√©tails</div>
            <div><label>N¬∞ Facture</label><input type="text" id="facture_num"></div>
            <div><label>Date</label><input type="date" id="facture_date"></div>
            
            <div class="full-width"><label>D√©signation</label><input type="text" id="detail_designation"></div>
            <div><label>Quantit√©</label><input type="number" id="detail_qte" value="1"></div>
            <div><label>PU HT</label><input type="number" step="0.01" id="detail_pu"></div>
            <div><label>Taux TVA</label><input type="number" step="0.1" id="detail_taux_tva" value="20"></div>
            <div><label>Total Ligne</label><input type="number" step="0.01" id="detail_total_ligne"></div>

            <div class="section-header">üí∞ Totaux</div>
            <div><label>Total HT</label><input type="number" step="0.01" id="total_ht"></div>
            <div><label>Total TVA</label><input type="number" step="0.01" id="total_tva"></div>
            <div class="full-width"><label style="color:#27ae60;">Total TTC</label><input type="number" step="0.01" id="total_ttc" style="font-weight:bold; border:2px solid #27ae60;"></div>

            <div class="section-header">‚öñÔ∏è Mentions</div>
            <div><label>√âch√©ance</label><input type="date" id="mention_echeance"></div>
            <div><label>P√©nalit√©s</label><input type="text" id="mention_penalites" value="Taux l√©gal"></div>
            <div><label>Indemnit√© 40‚Ç¨</label><input type="text" id="mention_indemnite" value="Oui"></div>
            <div><label>Bon Commande</label><input type="text" id="mention_bc"></div>
            <div><label>Assurance</label><input type="text" id="mention_assurance"></div>
            <div class="full-width"><label>Conditions</label><input type="text" id="mention_conditions"></div>
        </div>

        <div style="text-align:center; margin-top:20px;">
            <button class="btn btn-orange" onclick="addInvoiceToList()">‚ûï Valider</button>
            <button class="btn" style="background:#95a5a6; margin-top:10px;" onclick="resetUI()">Annuler</button>
        </div>
    </div>

    <div class="table-wrapper">
        <h3 style="padding:10px;">Donn√©es Enregistr√©es (Scroll ‚û°Ô∏è)</h3>
        <table id="invoices-table">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Date</th>
                    <th>N¬∞ Facture</th>
                    <th>Frs Nom</th>
                    <th>Frs Adresse</th>
                    <th>Frs SIRET</th>
                    <th>Frs Statut</th>
                    <th>Frs TVA</th>
                    <th>Client Nom</th>
                    <th>Client Adresse</th>
                    <th>Client TVA</th>
                    <th>D√©signation</th>
                    <th>Qt√©</th>
                    <th>PU HT</th>
                    <th>Taux TVA</th>
                    <th>Total Ligne</th>
                    <th>Total HT</th>
                    <th>Total TVA</th>
                    <th>Total TTC</th>
                    <th>√âch√©ance</th>
                    <th>P√©nalit√©s</th>
                    <th>Indemnit√©</th>
                    <th>Bon Cmd</th>
                    <th>Assurance</th>
                    <th>Conditions</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="25" style="text-align:center; padding:20px;">Aucune facture.</td></tr>
            </tbody>
        </table>
    </div>

    <div style="text-align:center; margin-top:20px; padding-bottom:50px;">
        <button id="btn-export" class="btn btn-green" onclick="exportFinalExcel()" disabled>üì• T√©l√©charger Excel</button>
    </div>
</div>

<script>
    let allInvoices = [];
    let videoStream = null;
    let track = null;
    let torchStatus = false;

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const cameraWrapper = document.getElementById('camera-wrapper');
    const previewImg = document.getElementById('preview-img');
    const statusText = document.getElementById('status');
    const dataForm = document.getElementById('data-form');
    const flashBtn = document.getElementById('flash-btn');

    // --- CAMERA ---
    async function startCamera() {
        resetUI();
        const constraints = { video: { facingMode: { exact: "environment" }, width: { ideal: 4096 }, focusMode: { ideal: "continuous" } } };
        try {
            videoStream = await navigator.mediaDevices.getUserMedia(constraints)
                .catch(err => navigator.mediaDevices.getUserMedia({ video: true }));
            video.srcObject = videoStream;
            cameraWrapper.style.display = 'block';
            track = videoStream.getVideoTracks()[0];
            if (track.getCapabilities().torch) flashBtn.style.display = 'flex';
        } catch (err) { alert("Erreur cam√©ra : " + err.message); }
    }

    async function toggleTorch() {
        if (!track) return;
        torchStatus = !torchStatus;
        await track.applyConstraints({ advanced: [{ torch: torchStatus }] });
        flashBtn.style.background = torchStatus ? "rgba(255,255,0,0.5)" : "rgba(0,0,0,0.5)";
    }

    function takePhoto() {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        previewImg.src = dataUrl; previewImg.style.display = 'block';
        if(videoStream) { if(torchStatus && track) track.applyConstraints({advanced:[{torch:false}]}); videoStream.getTracks().forEach(t=>t.stop()); }
        cameraWrapper.style.display = 'none'; flashBtn.style.display = 'none';
        runOCR(dataUrl);
    }

    // --- OCR ---
    async function runOCR(src) {
        statusText.innerText = "‚è≥ Analyse...";
        try {
            const { data: { text } } = await Tesseract.recognize(src, 'fra', { logger: m => { if(m.status==='recognizing text') statusText.innerText = `‚è≥ ${Math.round(m.progress*100)}%`; }});
            statusText.innerText = "‚úÖ Termin√©";
            parseTextToForm(text);
            dataForm.style.display = 'block';
            dataForm.scrollIntoView({ behavior: 'smooth' });
        } catch (e) { statusText.innerText = "‚ùå Erreur: " + e.message; }
    }

    function parseTextToForm(text) {
        document.querySelectorAll('input').forEach(i => i.value = ''); // Reset all
        document.getElementById('detail_qte').value = "1";
        document.getElementById('detail_taux_tva').value = "20";
        document.getElementById('mention_penalites').value = "Taux l√©gal";
        document.getElementById('mention_indemnite').value = "Oui";

        const find = r => (text.match(r)||[])[1]||'';
        const findRaw = r => (text.match(r)||[])[0]||'';

        let dateRaw = findRaw(/(\d{2}[\/\-]\d{2}[\/\-]\d{4})/);
        if(dateRaw) { let [d,m,y]=dateRaw.split(/[\/\-]/); document.getElementById('facture_date').value=`${y}-${m}-${d}`; }

        document.getElementById('emetteur_siret').value = findRaw(/\b\d{14}\b/);
        document.getElementById('facture_num').value = find(/Facture\s*n?¬∞?[:\s]*([A-Z0-9\-\/]+)/i);

        const prices = text.match(/\b\d+[\.,]\d{2}\b/g);
        if(prices) {
            const nums = prices.map(p => parseFloat(p.replace(',', '.'))).sort((a,b)=>b-a);
            if(nums[0]) document.getElementById('total_ttc').value = nums[0];
            if(nums[1]) document.getElementById('total_ht').value = nums[1];
            if(nums.length>1) document.getElementById('total_tva').value = (nums[0]-nums[1]).toFixed(2);
        }
        
        const lines = text.split('\n').filter(l => l.length>5 && !l.match(/facture|date|total/i));
        if(lines[0]) document.getElementById('detail_designation').value = lines[0].substring(0,50);
    }

    // --- GESTION DES DONNEES ---
    function addInvoiceToList() {
        const getVal = id => document.getElementById(id).value;
        const inv = {
            id: Date.now(),
            emetteur_nom: getVal('emetteur_nom'), emetteur_adresse: getVal('emetteur_adresse'), emetteur_siret: getVal('emetteur_siret'),
            emetteur_statut: getVal('emetteur_statut'), emetteur_tva: getVal('emetteur_tva'),
            client_nom: getVal('client_nom'), client_adresse: getVal('client_adresse'), client_tva: getVal('client_tva'),
            facture_num: getVal('facture_num'), facture_date: getVal('facture_date'),
            detail_designation: getVal('detail_designation'), detail_qte: getVal('detail_qte'), detail_pu: getVal('detail_pu'),
            detail_taux: getVal('detail_taux_tva'), detail_total: getVal('detail_total_ligne'),
            total_ht: getVal('total_ht'), total_tva: getVal('total_tva'), total_ttc: getVal('total_ttc'),
            mention_echeance: getVal('mention_echeance'), mention_penalites: getVal('mention_penalites'),
            mention_indemnite: getVal('mention_indemnite'), mention_bc: getVal('mention_bc'),
            mention_assurance: getVal('mention_assurance'), mention_conditions: getVal('mention_conditions')
        };
        allInvoices.push(inv);
        renderTable();
        resetUI();
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        const btnExport = document.getElementById('btn-export');
        tbody.innerHTML = "";

        if (allInvoices.length === 0) {
            tbody.innerHTML = '<tr><td colspan="25" style="text-align:center;">Aucune facture.</td></tr>';
            btnExport.disabled = true; return;
        }
        btnExport.disabled = false;

        // G√©n√©ration des 25 colonnes
        allInvoices.forEach((inv, i) => {
            tbody.innerHTML += `<tr>
                <td><button class="btn-red" onclick="deleteInvoice(${i})">X</button></td>
                <td>${inv.facture_date}</td>
                <td>${inv.facture_num}</td>
                <td>${inv.emetteur_nom}</td>
                <td>${inv.emetteur_adresse}</td>
                <td>${inv.emetteur_siret}</td>
                <td>${inv.emetteur_statut}</td>
                <td>${inv.emetteur_tva}</td>
                <td>${inv.client_nom}</td>
                <td>${inv.client_adresse}</td>
                <td>${inv.client_tva}</td>
                <td>${inv.detail_designation}</td>
                <td>${inv.detail_qte}</td>
                <td>${inv.detail_pu}</td>
                <td>${inv.detail_taux}</td>
                <td>${inv.detail_total}</td>
                <td>${inv.total_ht}</td>
                <td>${inv.total_tva}</td>
                <td style="font-weight:bold">${inv.total_ttc}</td>
                <td>${inv.mention_echeance}</td>
                <td>${inv.mention_penalites}</td>
                <td>${inv.mention_indemnite}</td>
                <td>${inv.mention_bc}</td>
                <td>${inv.mention_assurance}</td>
                <td>${inv.mention_conditions}</td>
            </tr>`;
        });
    }

    function deleteInvoice(i) { if(confirm("Supprimer ?")) { allInvoices.splice(i,1); renderTable(); } }
    
    function resetUI() { 
        dataForm.style.display='none'; previewImg.style.display='none'; statusText.innerText=''; 
        if(videoStream) { videoStream.getTracks().forEach(t=>t.stop()); cameraWrapper.style.display='none'; }
    }

    function exportFinalExcel() {
        // Mapping propre pour les en-t√™tes Excel
        const data = allInvoices.map(inv => ({
            "Nom √âmetteur": inv.emetteur_nom, "Adresse √âmetteur": inv.emetteur_adresse, "Statut Juridique": inv.emetteur_statut,
            "SIREN/SIRET": inv.emetteur_siret, "N¬∞ TVA √âmetteur": inv.emetteur_tva, "Nom Client": inv.client_nom,
            "Adresse Client": inv.client_adresse, "N¬∞ TVA Client": inv.client_tva, "Num√©ro Facture": inv.facture_num,
            "Date √âmission": inv.facture_date, "D√©signation": inv.detail_designation, "Quantit√©": inv.detail_qte,
            "Prix Unit. HT": inv.detail_pu, "Taux TVA (%)": inv.detail_taux, "Total Ligne HT": inv.detail_total,
            "Total HT Global": inv.total_ht, "Montant TVA": inv.total_tva, "Total TTC": inv.total_ttc,
            "√âch√©ance": inv.mention_echeance, "P√©nalit√©s": inv.mention_penalites, "Indemnit√© 40‚Ç¨": inv.mention_indemnite,
            "Bon Commande": inv.mention_bc, "Conditions Paiement": inv.mention_conditions, "Assurance": inv.mention_assurance
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Compta");
        XLSX.writeFile(wb, `Compta_Complet_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    document.getElementById('file-input').addEventListener('change', e => {
        const f = e.target.files[0]; if(!f)return;
        const r = new FileReader(); r.onload=ev=>{resetUI(); previewImg.src=ev.target.result; previewImg.style.display='block'; runOCR(ev.target.result);};
        r.readAsDataURL(f);
    });
</script>

</body>
</html>
